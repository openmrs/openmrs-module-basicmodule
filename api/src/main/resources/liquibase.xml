<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="Updating_Users-260620220317" author="Gogia, Swati">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM users where username = 'admin'
            </sqlCheck>
        </preConditions>
        <comment>Populate username for admin user</comment>
        <update tableName="users">
            <column name="username" value="admin"/>
            <where>system_id='admin'</where>
        </update>
    </changeSet>


    <changeSet id="Adding-ABHA-IdentifierType-220420210516"  author="Gogia, Swati">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from patient_identifier_type where name='ABHA'</sqlCheck>
        </preConditions>
        <comment>Adding ABHA Identifier type</comment>
        <sql>
            insert into patient_identifier_type( name, description,creator, uuid, uniqueness_behavior, location_behavior, date_created) Select 'ABHA','Health Id identifier type',creator,uuid(),'UNIQUE','NOT_USED',now() from users where username='admin';
        </sql>
    </changeSet>

    <changeSet id="updating-ABHA-globalProperty"  author="Gogia, Swati">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from patient_identifier_type where name='ABHA'</sqlCheck>
        </preConditions>
        <comment>Updating global property for ABHA identifier</comment>
        <sql>
            update global_property set property_value=(SELECT CONCAT(COALESCE(property_value,''),',',uuid) from patient_identifier_type where name = 'ABHA') where property = 'bahmni.extraPatientIdentifierTypes';
        </sql>
    </changeSet>

    <changeSet id="Adding-ABHA-Address-IdentifierType-220420210516"  author="Gogia, Swati">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from patient_identifier_type where name='ABHA Address'</sqlCheck>
        </preConditions>
        <comment>Adding ABHA Address Identifier type</comment>
        <sql>
            insert into patient_identifier_type( name, description,creator, uuid, uniqueness_behavior, location_behavior, date_created) Select 'ABHA Address','PHR Address identifier type',creator,uuid(),'UNIQUE','NOT_USED',now() from users where username='admin';
        </sql>
    </changeSet>

    <changeSet id="updating-ABHAAddress-globalProperty"  author="Gogia, Swati">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from patient_identifier_type where name='ABHA Address'</sqlCheck>
        </preConditions>
        <comment>Updating global property for ABHA address</comment>
        <sql>
            update global_property set property_value=(SELECT CONCAT(COALESCE(property_value,''),',',uuid) from patient_identifier_type where name = 'ABHA Address') where property = 'bahmni.extraPatientIdentifierTypes';
        </sql>
    </changeSet>

    <changeSet id="adding-undisclosed-to-gender-global-property" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from global_property where property = 'mrs.genders' and property_value='{"M":"Male", "F":"Female","O":"Other"}'
            </sqlCheck>
        </preConditions>
        <comment>Adding Undisclosed to gender</comment>
        <sql>
            update global_property set property_value='{"M":"Male", "F":"Female","O":"Other", "U":"Undisclosed"}' where property = 'mrs.genders';
        </sql>
    </changeSet>

</databaseChangeLog>
